params {
    // Pipeline metadata
    version = false
    
    // Input options
    help = false
    input = false
    metadata = false
    
    // Processing options
    skip_primer_trim = false
    skip_nb = false
    run_picrust2 = false
    download_db = false
    skip_phylotree = false
    
    // QC parameters
    filterQ = 20
    downsample = 0
    
    // DADA2 parameters
    min_len = 1000
    max_len = 1600
    omegac = "1e-40"
    max_ee = 2
    minQ = 0
    learn_error_sample = false
    pooling_method = 'pseudo'
    
    // ASV filtering parameters
    min_asv_totalfreq = 5  // Will be set to 0 for single sample
    min_asv_sample = 1       // Will be set to 0 for single sample
    
    // VSEARCH parameters
    maxreject = 100
    maxaccept = 100
    vsearch_identity = 0.97
    
    // Primer sequences (V1-V9 adapter by default)
    front_p = 'AGRGTTYGATYMTGGCTCAG'
    adapter_p = 'AAGTCGTAACAAGGTARCY'
    
    // Resource allocation
    dada2_cpu = 256
    vsearch_cpu = 256
    cutadapt_cpu = 64
    
    // Database paths
    vsearch_db = "${projectDir}/databases/GTDB_ssu_all_r220.qza"
    vsearch_tax = "${projectDir}/databases/GTDB_ssu_all_r220.taxonomy.qza"
    silva_db = "${projectDir}/databases/silva_nr99_v138.2_toSpecies_trainset.fa.gz"
    gg2_db = "${projectDir}/databases/gg2_2024_09_toSpecies_trainset.fa.gz"
    gtdb_db = "${projectDir}/databases/GTDB_bac120_arc53_ssu_r220_fullTaxo.fa.gz"
    
    // Database to prioritize, can be GG2, GTDB, or Silva
    db_to_prioritize = "GG2"
    
    // Script locations
    rmd_vis_biom_script = "${projectDir}/scripts/visualize_biom.Rmd"
    rmd_helper = "${projectDir}/scripts/import_biom.R"
    primer_fasta = "${projectDir}/scripts/16S_primers.fasta"
    dadaCCS_script = "${projectDir}/scripts/run_dada_2023.2.R"
    dadaAssign_script = "${projectDir}/scripts/dada2_assign_tax.R"
    learnError_script = "${projectDir}/scripts/learnError.R"
    
    // Output options
    outdir = "${launchDir}/results"
    publish_dir_mode = "rellink"
    colorby = "condition"
    rarefaction_depth = null
    
    // Container options
    enable_conda = false
    enable_container = false
    cacheDir = "/opt/conda/envs"
}

// env for qiime
env {
    TMPDIR = './tmp'
    MPLCONFIGDIR = "${TMPDIR}mpl/configdir"
    NUMBA_CACHE_DIR = "${TMPDIR}/numbacache"
    MAFFT_TMPDIR = "${TMPDIR}/mafft_tmpdir"
}

// Local executor configuration
executor {
    // Change to 'slurm' and uncomment queue if using Slurm scheduler
    name = 'Local'
    max_retries = 3
    // queue = 'defq'
}

// Default if using Local
process {
    // Default cpu if not specified
    cpus = 32
    // Set tmpdir before every process
    beforeScript = "mkdir -p ${env.TMPDIR}"
}

// Also add back the CPU and memory configurations
process {
    withLabel: cpu_def {
        cpus = 8
        memory = 32.GB
    }

    withLabel: cpu8 {
        cpus = 16
        memory = 64.GB
    }

    withLabel: cpu32 {
        cpus = 64
        memory = 256.GB
    }
}


// Docker/Singularity configuration
docker {
    enabled = params.enable_container
}

singularity {
    enabled = params.enable_container
	command = '/bin/singularity.AGI'
    autoMounts = true
}

// Execution profiles
profiles {
    standard {
        conda {
            useMamba = false
            conda.enabled = true
            // Allow longer conda creation timeout
            createTimeout = '2 h'
            cacheDir = "${params.cacheDir}"
        }
        params.enable_conda = true
        singularity.enabled = false
        singularity.automounts = false
        docker.enabled = false
        podman.enabled = false
        shifter.enabled = false
        charliecloud.enabled = false
    }
    conda {
        conda {
            useMamba = false
            conda.enabled = true
            // Allow longer conda creation timeout
            createTimeout = '2 h'
        	// Use the same standard conda cache
            cacheDir = "${params.cacheDir}"
        }
        params.enable_conda = true
        singularity.enabled = false
        singularity.automounts = false
        docker.enabled = false
        podman.enabled = false
        shifter.enabled = false
        charliecloud.enabled = false
    }
    singularity {
        singularity.enabled = true
        singularity.autoMounts = true
    	// Put the Singularity cache under the standard conda cache
        singularity.cacheDir = "${params.cacheDir}/singularity"
	    // Bind the standard cache to qiime2's home dir inside the docker image
		singularity.runOptions = "--bind ${env.TMPDIR}:./tmp --bind ${params.cacheDir}:/home/qiime2"
        params.enable_container = true
        docker.enabled = false
        podman.enabled = false
        shifter.enabled = false
        charliecloud.enabled = false
    }
    docker {
        singularity.enabled = false
        singularity.autoMounts = false
        docker.enabled = true
        params.enable_container = true
        podman.enabled = false
        shifter.enabled = false
        charliecloud.enabled = false
    }
}

// Execution reports
report {
    enabled = true
    file = "${params.outdir}/execution_report.html"
    overwrite = true
}

timeline {
    enabled = true
    file = "${params.outdir}/timeline.html"
    overwrite = true
}

dag {
    enabled = true
    file = "${params.outdir}/dag.html"
    overwrite = true
}

trace {
    enabled = true
    file = "${params.outdir}/execution_trace.txt"
    overwrite = true
}
